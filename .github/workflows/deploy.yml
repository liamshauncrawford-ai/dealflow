name: Build & Deploy

on:
  push:
    branches: [main]

permissions:
  contents: read
  deployments: write

jobs:
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build
        run: npm run build
        env:
          DATABASE_URL: 'postgresql://fake:fake@localhost:5432/fake'

  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production
      url: https://dealflow-production-0240.up.railway.app
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Trigger Railway Deployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_SERVICE_ID: ${{ secrets.RAILWAY_SERVICE_ID }}
        run: |
          node -e "
          async function deploy() {
            const query = \`
              mutation {
                serviceInstanceRedeploy(
                  serviceId: \\\"\${process.env.RAILWAY_SERVICE_ID}\\\"
                )
              }
            \`;

            const response = await fetch('https://backboard.railway.com/graphql/v2', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + process.env.RAILWAY_TOKEN
              },
              body: JSON.stringify({ query })
            });

            const result = await response.json();
            if (result.errors) {
              console.error('Railway deploy failed:', JSON.stringify(result.errors));
              process.exit(1);
            }
            console.log('Railway deployment triggered successfully');
            console.log('Result:', JSON.stringify(result.data));
          }

          deploy().catch(err => {
            console.error('Deploy error:', err.message);
            process.exit(1);
          });
          "

      - name: Post Deployment Status
        if: success()
        run: |
          echo "## :rocket: Deployed to Production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://dealflow-production-0240.up.railway.app" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
